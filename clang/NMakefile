CMAKE=cmake
VCBUILD=$(VS90COMNTOOLS)\..\..\VC\VCPackages\vcbuild
JOBS=1

#CMAKE=c:\program files\CMake 2.8\bin\cmake
#JOBS=4

###

# Instead of jiggling the project files to only install the bits we want, we do
# a real install into the OBJROOT, and then copy the exact bits we want to the
# DSTROOT.
#
# It would be nice to not build unnecessary stuff though, to save build time.
STAGEROOT=$(OBJROOT)\install

BINDEST=$(DSTROOT)\AppleInternal\bin

all:
	@echo "usage: make [target]"
	@echo
	@echo "Available Targets:"
	@echo "  configure: configure using CMake (inside OBJROOT)"
	@echo "  build    : build using vcbuild.exe (inside OBJROOT)"
	@echo "  install  : configure, build and install"

configure:
	"$(CMAKE)" -E make_directory "$(OBJROOT)"
	cd "$(OBJROOT)"
	"$(CMAKE)" "-DCMAKE_INSTALL_PREFIX:=$(STAGEROOT)" \
	         -DLLVM_TARGETS_TO_BUILD:=X86 \
	         -G "Visual Studio 9 2008" \
	         "$(SRCROOT)\src"

build: configure
	cd "$(OBJROOT)"
	"$(VCBUILD)" /M$(JOBS) /r LLVM.sln "Release|Win32"
	"$(VCBUILD)" /M$(JOBS) /r INSTALL.vcproj "Release|Win32"

install: build
	"$(CMAKE)" -E make_directory "$(BINDEST)"
	xcopy /i/y "$(STAGEROOT)\bin\clang.exe" "$(BINDEST)"
