##==-- test/Makefile.test - Common make rules Java tests -*- makefile -*--====##
#
#                     The LLVM Compiler Infrastructure
#
# This file was developed by the LLVM research group and is distributed under
# the University of Illinois Open Source License. See LICENSE.TXT for details.
#
##===----------------------------------------------------------------------===##

include $(LEVEL)/Makefile.common

.PHONY: clean

clean::
	$(Verb)$(RM) -f a.out core
	$(Verb)$(RM) -rf Output/

# we don't want these files to be deleted by make, even if they are
# intermediate results
.PRECIOUS: Output/.dir %.linked.bc %.raw.bc %.ll %.llvm.bc

#rule to link in runtime to raw bytecode
%.linked.bc: %.raw.bc $(LibDir)/libjrt.bc $(EXTRA_OBJS)
	$(Echo) Linking $< with the Java runtime
	$(Verb)$(LLINK) $^ -o=$@

# rule to optimize the linked bytecode
%.llvm.bc: %.linked.bc $(LOPT)
	$(Echo) Optimizing $<
	$(Verb)$(LOPT) -simplifycfg -mem2reg -instcombine -f -o=$@ $<

# rule to make assembly from bytecode
%.dis-ll: %.bc
	$(Echo) Disassembling $<
	$(Verb)$(LDIS) -f -o=$@ $<

# rule to compile java sources
ifdef JAVA_TESTS
Output/.compile-java: $(addsuffix .java,$(JAVA_TESTS))
	$(Echo) Compiling $?
	$(Verb)mkdir -p Output
	$(Verb)$(JAVAC) -d Output $?
	$(Verb)touch $@
endif

# rule to run a .class file with the jvm
%.out-nat: %.class
	$(Verb)$(JAVA) -cp Output $(subst /,.,$(subst Output/,,$*)) > $*.out-nat || rm -f $*.out-nat

# rule to run a .class file with the llvm jit
%.out-jit: %.llvm.bc
	$(Verb)$(LLI) $< > $*.out-jit
